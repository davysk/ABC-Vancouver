"use strict";const WPFormsGeolocationMapboxAPI=window.WPFormsGeolocationMapboxAPI||function(n,a){const i=[],r={getFirstFeature:function(e){return e&&Object.prototype.hasOwnProperty.call(e,"features")&&e.features.length?e.features.shift():null},getFeatureProperties:function(e){return Object.prototype.hasOwnProperty.call(e,"properties")?e.properties:null},getFeatureProperty:function(e,t){const o=r.getFeatureProperties(e);return Object.prototype.hasOwnProperty.call(o,t)?["region_code","country_code"].includes(t)?o[t].toUpperCase():o[t]:""},getFeatureCoordinates:function(e){return Object.prototype.hasOwnProperty.call(e,"geometry")&&Object.prototype.hasOwnProperty.call(e.geometry,"coordinates")?{lng:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]}:wpforms_geolocation_settings.default_location},prepareProperties:function(e){const o={};return e.context.forEach(function(e){var t=e.id.split(".")[0];o[t]=e.text,Object.prototype.hasOwnProperty.call(e,"short_code")&&(o[t+"_code"]=e.short_code.replace(/^US-/,""))}),Object.prototype.hasOwnProperty.call(e,"text")&&(o.address_line1=e.text),Object.prototype.hasOwnProperty.call(e,"address")&&(o.address_line1+=" "+e.address),Object.prototype.hasOwnProperty.call(e,"place_name")&&(o.place_name=e.place_name),o}},o={receivePlace:function(e,o){const s=new XMLHttpRequest,t=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e.lng},${e.lat}.json`);t.searchParams.set("access_token",wpforms_geolocation_settings.autocompleteSettings.common.access_token),t.searchParams.set("limit","1"),t.searchParams.set("type","address"),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){const e=JSON.parse(s.responseText),t=r.getFirstFeature(e);t&&(t.properties=r.prepareProperties(t),o(t))}},s.open("GET",t.toString()),s.send()}},s={getStateCoordinates:function(e,t){if(!e.settings.autocompleteSettings.strict)return null;e=e.settings.autocompleteSettings.strict.toString().toLowerCase();return Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states,e)&&Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states[e],t)?wpforms_geolocation_settings.states[e][t]:null}},c={init:function(){"loading"===n.readyState?n.addEventListener("DOMContentLoaded",c.ready):c.ready()},ready:function(){c.getFields(),i.length&&(n.onwpformsProcessConditionalsField=function(e,t,o){const s=n.getElementById("wpforms-"+t+"-field_"+o);s&&s.hasAttribute("data-autocomplete")&&a.dispatchEvent(new Event("resize"))},i.forEach(function(e){c.initMap(e),c.initAutocomplete(e)}),c.detectGeolocation())},showDebugMessage:function(e){a.location.hash&&"#wpformsdebug"===a.location.hash&&console.log(e)},getFields:function(){const e=Array.prototype.slice.call(n.querySelectorAll('.wpforms-form .wpforms-field input[type="text"][data-autocomplete="1"]'));e.forEach(function(e){const t=e.closest(".wpforms-field"),o=e.hasAttribute("data-display-map")?t.querySelector(".wpforms-geolocation-map"):null,s=t.classList[1]?t.classList[1].replace("wpforms-field-",""):"text";let n={};var a;"address"===s&&(n={address_line1:t.querySelector(".wpforms-field-address-address1"),address_line2:t.querySelector(".wpforms-field-address-address2"),place:t.querySelector(".wpforms-field-address-city"),postcode:t.querySelector(".wpforms-field-address-postal"),country_code:t.querySelector(".wpforms-field-address-country")},"SELECT"===(a=t.querySelector(".wpforms-field-address-state")).tagName?n.region_code=a:n.region=a),i.push({searchField:e,mapField:o,type:s,additionalFields:n,settings:c.getFieldSettings(e)})})},getFieldSettings:function(e){e=e.getAttribute("id").replaceAll("-","_");return{autocompleteSettings:c.getFieldAutocompleteSettings(e),mapSettings:c.getFieldMapSettings(e),markerSettings:c.getFieldMarkerSettings(e)}},getFieldAutocompleteSettings:function(e){return Object.assign({},wpforms_geolocation_settings.autocompleteSettings.common||{},wpforms_geolocation_settings.autocompleteSettings[e]||{})},getFieldMapSettings:function(e){return Object.assign({trackResize:!0},wpforms_geolocation_settings.mapSettings.common||{},wpforms_geolocation_settings.mapSettings[e]||{})},getFieldMarkerSettings:function(e){return Object.assign({draggable:!0},wpforms_geolocation_settings.markerSettings.common||{},wpforms_geolocation_settings.markerSettings[e]||{})},initMap:function(t){if(t.mapField){mapboxgl.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.map=new mapboxgl.Map(Object.assign({container:t.mapField},t.settings.mapSettings)),t.map.addControl(new mapboxgl.NavigationControl),t.marker=new mapboxgl.Marker(t.settings.markerSettings).setLngLat([t.settings.mapSettings.center.lng,t.settings.mapSettings.center.lat]).addTo(t.map),t.marker.on("dragend",c.markerChanged);const e=new MutationObserver(function(e){e.forEach(function(){t.map.resize()})});e.observe(t.mapField.parentElement,{attributes:!0,attributeFilter:["style"]})}},updateMap:function(e,t){e.map&&e.marker&&(t=r.getFeatureCoordinates(t),e.marker.setLngLat([t.lng,t.lat]),e.map.setCenter([t.lng,t.lat]))},markerChanged:function(){const t=c.findFieldPlaceBy("map",this._map);t&&o.receivePlace(this.getLngLat(),function(e){c.updateMap(t,e),c.updateFields(t,e)})},findFieldPlaceBy:function(t,o){let s=null;return i.some(function(e){if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]===o||e.additionalFields&&Object.prototype.hasOwnProperty.call(e.additionalFields,t)&&e.additionalFields[t]===o)return s=e,!0}),s},initAutocomplete:function(e){mapboxsearch.config.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token;const t=n.createElement("mapbox-address-autofill");t.append(e.searchField.cloneNode(!0)),e.searchField.replaceWith(t),t.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.options=e.settings.autocompleteSettings,e.autocomplete=t,e.searchField=t.querySelector("input"),e.autocomplete.addEventListener("retrieve",c.updateFieldPlace),-1!==navigator.userAgent.indexOf("Chrome")&&e.searchField.setAttribute("autocomplete","chrome-off"),"address"===e.type&&(e.additionalFields.address_line1=e.searchField,c.bindAddressFieldEvents(e))},bindAddressFieldEvents:function(e){if(e.additionalFields.country_code&&e.additionalFields.country_code.addEventListener("change",c.updateCountry),e.settings.autocompleteSettings.strict){const t=Array.isArray(e.settings.autocompleteSettings.strict)?e.settings.autocompleteSettings.strict.shift():e.settings.autocompleteSettings.strict;e.settings.autocompleteSettings.strict=t,e.autocomplete.options.country=t.toString().toUpperCase(),e.additionalFields.region_code.addEventListener("change",c.updateArea)}},updateFieldPlace:function(e){var t=c.findFieldPlaceBy("autocomplete",e.target);t&&(e=r.getFirstFeature(e.detail),c.updateFields(t,e),c.updateMap(t,e))},updateFields:function(e,t){"text"===e.type?c.updateTextField(e,t):"address"===e.type&&c.updateAddressField(e,t),c.showDebugMessage("Fields was updated"),c.showDebugMessage(e),c.showDebugMessage(t)},updateTextField:function(e,t){e.searchField.value=r.getFeatureProperty(t,"place_name"),c.triggerEvent(e.searchField,"change")},updateAddressField:function(e,t){c.clearAdditionalFields(e);for(var[o,s]of Object.entries(e.additionalFields))s&&((o=r.getFeatureProperty(t,o))&&(c.isConversationalSelect(s)?c.updateConversationalSelect(s,o):(s.value=o,c.triggerEvent(s,"change"))))},isConversationalSelect:function(e){return"SELECT"===e.tagName&&Boolean(e.closest(".wpforms-conversational-select"))},updateConversationalSelect:function(e,t){const o=e.closest(".wpforms-conversational-select"),s=e.querySelector('option[value="'+t+'"]'),n=o.querySelector(".wpforms-conversational-form-dropdown-input input");e.value=t,s&&n&&(n.value=s.innerText)},triggerEvent:function(e,t){t=new Event(t,{bubbles:!0,cancelable:!0});e.dispatchEvent(t)},clearAdditionalFields:function(e){e.additionalFields&&Object.values(e.additionalFields).forEach(function(e){e&&(e.value="")})},updateCountry:function(){const e=c.findFieldPlaceBy("country_code",this),t=this.value.toString().toUpperCase();e&&e.autocomplete&&(e.autocomplete.options.country=t,c.showDebugMessage("Autocomplete field restrict to country: "+t))},updateArea:function(){const e=c.findFieldPlaceBy("region_code",this),t=this.value.toString().toUpperCase(),o=s.getStateCoordinates(e,t);c.showDebugMessage("Autocomplete field try to find the "+t+" state"),e&&t&&o||c.showDebugMessage("Autocomplete field doesn't restrict to the "+t+" state"),e.autocomplete.options.proximity=o,c.showDebugMessage("Autocomplete field restrict to the "+t+" state")},detectGeolocation:function(){wpforms_geolocation_settings.current_location&&navigator.geolocation&&i&&navigator.geolocation.getCurrentPosition(function(e){e={lat:e.coords.latitude.toFixed(6),lng:e.coords.longitude.toFixed(6)};o.receivePlace(e,function(o){i.forEach(function(e){const t=e.searchField.closest(".wpforms-field");t.classList.contains("wpforms-conditional-hide")||(c.updateMap(e,o),c.updateFields(e,o))})})})}};return c}(document,window);WPFormsGeolocationMapboxAPI.init();